local peripheral, fs, textutils, math = 
      peripheral, fs, textutils, math

local settings = {
  activateAt = 0.5,
  deactivateAt = 0.8,
  maxStored = 10e6
}

local reactor = peripheral.wrap("right")
local monitor = peripheral.wrap("front")
monitor.clear()
monitor.setTextScale(0.5)
local w, h = monitor.getSize()
term.redirect(monitor)

local production = 0
local current = 0
local charge = false

local settingsPath = "data/settings"

local function saveSettings()
  local f = fs.open(settingsPath, "w")
  if not f then return false end
  f.write(textutils.serialize(state))
  f.close()
  return true
end

local function loadSettings()
  if not fs.exists(settingsPath) or fs.isDir(settingsPath) then return false end
  local f = fs.open(settingsPath, "r")
  settings = textutils.unserialize(f.readAll())
  f.close()
  return true
end

local function readReactor()
  current = 1e6--reactor.getEnergyStored()
  production = reactor.getEnergyProducedLastTick()
end

local function drawBar()
  paintutils.drawFilledBox(w-8, 2, w-2, h-1, colors.gray)
  local level = (w-2)*current/settings.maxStored
  paintutils.drawFilledBox(w-8, h-1-math.floor(level), w-2, h-1, charge and colors.yellow or colors.lime)
  if level-math.floor(level)>=0.5 then
    paintutis.drawLine(w-8, h-2-math.floor(level), w-2, h-2-math.floor(level), charge and colors.brown or colors.green)
  end
  term.setBackgroundColor(colors.black)
  term.setCursorPos(w-1, h-1-math.floor((h-2)*settings.activateAt))
  term.setTextColor(colors.lime)
  write("<")
  term.setCursorPos(w-1, h-1-math.floor((h-2)*settings.deactivateAt))
  term.setTextColor(colors.red)
  write("<")
end

loadSettings()
readReactor()
drawBar()